# תכנית מעודכנת: בניית ארכיטקטורת משחק קטאן

בניית מבנה מודולרי מסודר למשחק קטאן עם הפרדה ברורה בין **קונפיגורציה (JSON)**, **מבנה נתונים (Models)**, **לוגיקה (Rules)**, ו**בקר (Engine)**. הארכיטקטורה תאפשר חלוקת עבודה קלה לסוכנים עם תלויות מינימליות בין מודולים.

**טכנולוגיה:** TypeScript עם Node.js (Type Safety + מבנה מודולרי חזק)
**ממשק:** CLI בהתחלה → Web UI (React/Vue) בהמשך
**מולטיפלייר:** תכנון מראש ל-API Stateless עם פקודות אטומיות

---

## שלבים

### 1. הגדרת מבנה נתונים פיזי של הלוח
יצירת config/board.json המגדיר: 19 אריחי שטח (4 יער, 4 חיטה, 4 כבשים, 3 הרים, 3 גבעות, 1 מדבר), 18 אסימוני מספרים (2-12 ללא 7), 9 נמלי סחר (4 כלליים 3:1, 5 ספציפיים 2:1). **חשוב:** הקובץ יכלול גם **מפת קשרים** בין קודקודים (54), צלעות (72), ואריחים - זה יכתיב את מבנה HexGraph.ts

### 2. יצירת מחירון ומלאי משאבים
config/costs.json עם עלויות בניה (כביש=1 לבנה+1 עץ, כפר=1 לבנה+1 עץ+1 צמר+1 חיטה, עיר=3 עפרות+2 חיטה, קלף התפתחות=1 עפרות+1 צמר+1 חיטה), ו-config/resources.json המגדיר **מלאי מקסימלי בבנק**: 19 כרטיסים מכל סוג משאב, 25 קלפי התפתחות (14 אביר, 5 VP, 2 בניית כבישים, 2 מונופול, 2 שנת שפע). הניהול הדינמי יהיה ב-ResourceManager

### 3. הגדרת חוקי משחק כמודולים
מחלקות ב-src/rules/: DiceRules (זריקה והפקת משאבים בשלבים: א) קביעת אריחים מופעלים, ב) בדיקת חסימת שוד, ג) איסוף משאבים לכל שחקן, ד) העברה ל-ResourceManager), RobberRules (שביעייה: השלכת מחצית משאבים מעל 7, הזזה, גניבה), TradingRules (אכיפת יחסי 4:1/3:1/2:1, בהפרדה מהחלטות השחקן), BuildingRules (חוק מרחק, חיבור כבישים, **אלגוריתם BFS/DFS לחישוב הדרך הארוכה ביותר**)

### 4. מודל שחקן ורכיבים
src/models/Player.ts עם: 5 כפרים, 4 ערים, 15 כבישים לכל שחקן, מעקב משאבים וקלפי התפתחות, חישוב נקודות (כפר=1, עיר=2, קלפי VP, הדרך הארוכה=2 ב-5+ כבישים רצופים, הצבא הגדול=2 ב-3+ אבירים). src/models/ResourceTile.ts, src/models/Vertex.ts, src/models/Edge.ts כמבני בסיס

### 5. מנוע משחק וניהול מצב - Source of Truth
src/game/GameState.ts כ-**Immutable State** - כל הסטייט שמור כאן ולא ניתן לשינוי ישיר. src/game/GameEngine.ts כמתאם ראשי: מקבל בקשות מ-PlayerAgent, שולח לולידציה ב-Rules, ורק אם מאושר מעדכן GameState. מנהל: התחלה (2 סיבובי מיקום עם משאבים מכפר שני), זרימת תורות (**פקודות אטומיות**: RollDice, BuildRoad, OfferTrade), תנאי ניצחון (10 נקודות)

### 6. גנרטור לוח ומערכת גרף
src/board/BoardGenerator.ts ליצירת לוח אקראי מאוזן (סידור אריחים ומספרים), ו-src/board/HexGraph.ts לייצוג גרף מלא של קודקודים, צלעות, ואריחים עם: קשרי שכנות, **אלגוריתם חישוב דרכים רצופות** (BFS/DFS), בדיקת תקינות מיקום, ו-src/managers/ResourceManager.ts לניהול מלאי הבנק והחלוקת משאבים

---

## שיקולים ארכיטקטוניים

### 1. Type Safety עם TypeScript
**החלטה:** TypeScript היא הבחירה העדיפה. המשחק מונחה-חוקים מורכב והזקוק ל-Type Safety חזק. מבנה מודולרי עם מחלקות, ממשקים, ו-Enums ימנע שגיאות ויקל על פיתוח סוכנים עתידיים

### 2. הפרדת לוגיקה מתצוגה
**שלב א':** CLI פשוט שמציג סטייט בטקסט. כל פונקציה ב-GameEngine מחזירה סטייט או שגיאה **ללא** הצגה ישירה
**שלב ב':** Web UI (React/Vue) שמתחבר ל-API של ה-Engine. TS/Node.js משתלב חלק עם פלטפורמות web

### 3. תכנון מראש למולטיפלייר
GameEngine כמערכת **Stateless** בין פעולות. תקשורת דרך **פקודות אטומיות** (BuildRoad, OfferTrade) מאפשרת הוספה עתידית של שרת WebSocket לחיבור שחקנים מרחוק ללא שינויי ליבה במנוע

### 4. Immutability ו-Source of Truth
GameState הוא ה-Source of Truth היחיד. כל שינוי עובר דרך GameEngine עם ולידציה ב-Rules. זה מאפשר undo/redo, multiplayer sync, ושמירת היסטוריה

---

## סיכום צעדים ראשונים

1. **הקמת פרויקט TypeScript** עם מבנה תיקיות: src/models/, src/rules/, src/game/, src/board/, src/managers/, config/
2. **יצירת קבצי JSON** בסיסיים: board.json, costs.json, resources.json
3. **מודלים בסיסיים:** ResourceTile.ts, Vertex.ts, Edge.ts, Player.ts
4. **HexGraph.ts** - מבנה הגרף המלא עם קשרי שכנות
5. **GameState.ts** - Immutable state כ-Source of Truth
6. **GameEngine.ts** - המתאם עם פקודות אטומיות

זה יהיה הבסיס המוצק לחלוקת משימות לסוכנים!

---

## נתונים פיזיים מלאים - לעיון מהיר

### מבנה הלוח
- **19 אריחים:** 4 יער, 4 חיטה, 4 כבשים, 3 הרים, 3 גבעות, 1 מדבר
- **18 מספרים:** 1×(2,12), 2×(3,4,5,6,8,9,10,11)
- **9 נמלים:** 4 כלליים (3:1), 5 ספציפיים (2:1)
- **גרף:** 54 קודקודים, 72 צלעות

### משאבים
- **95 משאבים:** 19 מכל סוג (עץ, חיטה, צמר, לבנים, עפרות)
- **25 קלפי התפתחות:** 14 אביר, 5 VP, 2 בניית כבישים, 2 מונופול, 2 שנת שפע

### רכיבי שחקן (לכל שחקן)
- 5 כפרים, 4 ערים, 15 כבישים

### מחירון
- כביש: 1 לבנה + 1 עץ
- כפר: 1 לבנה + 1 עץ + 1 צמר + 1 חיטה
- עיר: 3 עפרות + 2 חיטה (שדרוג מכפר)
- קלף התפתחות: 1 עפרות + 1 צמר + 1 חיטה

### חוקים מרכזיים
- **קוביות:** 2-6,8-12 מייצרים משאבים (כפר=1, עיר=2), 7 מפעיל שוד
- **שוד:** השלכה ב-8+ כרטיסים, הזזה, גניבה, חסימת אריח
- **סחר:** 4:1 בנק, 3:1 נמל כללי, 2:1 נמל ספציפי, חופשי בין שחקנים
- **בניה:** כבישים רצופים, חוק מרחק לכפרים, עיר במקום כפר
- **ניצחון:** 10 נקודות (כפר=1, עיר=2, דרך ארוכה=2, צבא גדול=2, קלפי VP)